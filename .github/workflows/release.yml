name: Create GitHub Release

on:
  push:
    tags:
      - "v*.*.*"   # triggers on tags like v1.0.0, v1.2.3

permissions:
  contents: write   # required to create GitHub Releases

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history required for changelog generation

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests (gate â€” release only if green)
        run: uv run pytest tests/

      - name: Build package
        run: uv build   # produces dist/*.whl and dist/*.tar.gz

      - name: Generate release notes
        run: |
          CURRENT_TAG="${GITHUB_REF_NAME}"
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

          {
            if [ -z "$PREV_TAG" ]; then
              echo "### Changes"
              echo ""
              git log --pretty=format:"- %s"
            else
              echo "### Changes since ${PREV_TAG}"
              echo ""
              git log --pretty=format:"- %s" "${PREV_TAG}..${CURRENT_TAG}"
              echo ""
              echo ""
              echo "**Full changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
            fi
          } > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md   # auto-generated changelog
          files: dist/*                 # attach .whl and .tar.gz as assets
          make_latest: true
